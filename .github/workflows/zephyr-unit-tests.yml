name: Zephyr Unit Tests

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  gpio_event_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            python3-pip \
            python3-venv \
            device-tree-compiler \
            gcc-multilib \
            libc6-dev-i386

      - name: Install Zephyr SDK
        run: |
          curl -fsSL -o /tmp/zephyr-sdk.tar.xz \
            https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.0/zephyr-sdk-0.16.0_linux-x86_64.tar.xz
          tar -C /opt -xf /tmp/zephyr-sdk.tar.xz
          /opt/zephyr-sdk-0.16.0/setup.sh -t all -c

      - name: Install west
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install west pyelftools

      - name: Initialize west workspace
        run: |
          west init -l nrf

      - name: Update west modules (shallow)
        run: |
          west update --narrow -o=--depth=1

      - name: Run Zephyr tests (native_posix)
        env:
          BOARD: native_posix
          ZEPHYR_BASE: ${{ github.workspace }}/zephyr
          ZEPHYR_SDK_INSTALL_DIR: /opt/zephyr-sdk-0.16.0
          ZEPHYR_TOOLCHAIN_VARIANT: zephyr
        run: |
          bash tools/test_zephyr_linux.sh
