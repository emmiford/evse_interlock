# Setup

This document consolidates local setup, build/flash, and provisioning notes for
the RAK4631 (nRF52840) Sidewalk device.

## Hardware Target

- Board: `rak4631` (nRF52840)
- Radio: Semtech sx1262

## Versions (known-good)

- nRF Connect SDK: v3.0.0-3bfc46578e42
- Zephyr: v4.0.99-ncs1
- Sidewalk add-on: v0.1.99-addon-ff9b3a40843a
- Sidewalk SDK: 1.19.4.20
- Zephyr SDK: 0.16.0 (or 0.17.0 if installed locally)

## Required Files (local only)

- Provisioning JSON: `.secrets/sidewalk/certificate.json`
- PM static file: `app/evse_interlock_v1/conf/pm_static_rak4631_nrf52840.yml`
- Optional batch inputs:
  - `tools/devices_batch.csv` (copy from `tools/devices_batch.csv.example`)
  - `tools/site_id_key.b64` (generated by `tools/site_id_from_address.py`)

## Build + Flash (CLI)

```bash
rm -rf /Users/jan/dev/sidewalk-workspace/build

tools/west_build_with_patch.sh -p always -d /Users/jan/dev/sidewalk-workspace/build \
  -b rak4631 /Users/jan/dev/sidewalk-workspace/app/evse_interlock_v1 -- \
  -DCONF_FILE=conf/prj.conf \
  -DDTC_OVERLAY_FILE=conf/rak4631.overlay \
  -DPM_STATIC_YML_FILE:FILEPATH=/Users/jan/dev/sidewalk-workspace/app/evse_interlock_v1/conf/pm_static_rak4631_nrf52840.yml \
  -Dmcuboot_PM_STATIC_YML_FILE:FILEPATH=/Users/jan/dev/sidewalk-workspace/app/evse_interlock_v1/conf/pm_static_rak4631_nrf52840.yml

west flash --runner pyocd --build-dir /Users/jan/dev/sidewalk-workspace/build -- \
  --target nrf52840 --dev-id 0700000100120036470000124e544634a5a5a5a597969908
```

## RTT Console

```bash
pyocd rtt -t nrf52840 -u 0700000100120036470000124e544634a5a5a5a597969908
```

Notes:
- The build wrapper auto-applies the Sidewalk BLE gating patch:
  - `app/evse_interlock_v1/patches/sidewalk-ble-off.patch`
- Bluetooth is enabled by default in `app/evse_interlock_v1/conf/prj.conf`.
  - To disable BT, add `-DOVERLAY_CONFIG=conf/features/no_bt.conf`.

## Provisioning (single device)

```bash
cd /Users/jan/dev/sidewalk-workspace/sidewalk/tools/provision
pip install -r requirements.txt

python3 provision.py nordic aws \
  --certificate_json /Users/jan/dev/sidewalk-workspace/.secrets/sidewalk/certificate.json \
  --addr 0xFC000 \
  --output_bin mfg.bin \
  --output_hex rak4631_mfg.hex

pyocd flash -t nrf52840 -u 0700000100120036470000124e544634a5a5a5a597969908 \
  rak4631_mfg.hex
```

## Provisioning (batch)

This flow provisions multiple devices from a CSV and flashes them one at a time.
It does not create IoT Things.

Inputs:
- CSV path (default): `tools/devices_batch.csv`
- Required columns:
  - `address` (e.g. `4223 Knox Ct, Denver, CO 80211`)
  - `sidewalk_sn` (full SMSN) OR `certificate_json_path`

Example CSV:
```
address,sidewalk_sn,certificate_json_path
4223 Knox Ct, Denver, CO 80211,2506270BC068CB9767F698F9548583B17C1DD6238EC26502A65167B789D54998,
4599 W 36th Pl, Denver, CO 80212,,/path/to/certificate_4599.json
```

Run:
```
python3 tools/provision_batch.py > bash_output.txt 2>&1
```

Defaults (override via flags):
- Region: `us-east-1`
- Device profile: `d01c298b-0a71-4ec6-9cb6-33d8ae2286b9`
- Destination: `SensorAppDestination`
- Hardware rev: `RAK4630`
- Firmware rev: `v1.1.0-add-on`
- Device type: `EVSE`
- Customer ID: `default`

## Troubleshooting

- `PM_MCUBOOT_SECONDARY_ID` missing or `mfg_storage` undefined
  - Cause: PM static file not applied. Use the absolute `PM_STATIC_YML_FILE`
    and `mcuboot_PM_STATIC_YML_FILE` arguments.
- `mfg.hex version mismatch`
  - Cause: mfg data not provisioned. Re-run `provision.py` and flash
    `rak4631_mfg.hex` to `0xFC000`.
- No serial devices
  - Use RTT via `pyocd rtt` instead of UART.
